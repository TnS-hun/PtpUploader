{% extends "layout.html" %}

{% block head %}
	<title>PtpUploader - Jobs</title>
{% endblock %}

{% block body %}
<table class="jobs" border="0" cellpadding="3" cellspacing="1">
	<tr>
		<th>Release name</th>
		<th>Source</th>
		<th>Size</th>
		<th>Edit</th>
	</tr>

	<tbody>
		{% for entry in entries %}
			<tr>
				<td class="name">
					<a href="{{ entry.LogPageUrl }}"><img src={{ entry.StateIcon }} title="{{ entry.State }}"></a>

					<span class="title">
					{% if entry.PtpUrl %}
						<a href="{{ entry.PtpUrl }}">{{ entry.ReleaseName }}</a>
					{% else %}
						{{ entry.ReleaseName }}
					{% endif %}
					</span>

					{% if entry.ErrorMessage %}
						<br>
						{{ entry.ErrorMessage }}
					{% endif %}
				</td>
				<td>
					{% if entry.SourceIcon %}
						{% if entry.SourceUrl %}
							<a href="{{ entry.SourceUrl }}"><img src={{ entry.SourceIcon }}></a>
						{% else %}
							<img src={{ entry.SourceIcon }}>
						{% endif %}
					{% endif %}
				</td>
				<td>
					{{ entry.Size }}
				</td>
				<td class="jobbuttons">
					{% if entry.StartJobUrl %}
						<a href="#" onclick='executeJobCommand( this, {{ entry.Id }}, "/start/" ); return false;'><img src={{ url_for( "static", filename = "start.png" ) }} title="Start"></a>
					{% endif %}
					{% if entry.StopJobUrl %}
						<a href="#" onclick='executeJobCommand( this, {{ entry.Id }}, "/stop/" ); return false;'><img src={{ url_for( "static", filename = "stop.png" ) }} title="Stop"></a>
					{% endif %}
					{% if entry.EditJobUrl %}
						<a href="{{ entry.EditJobUrl }}"><img src={{ url_for( "static", filename = "edit.png" ) }} title="Edit"></a>
					{% endif %}
					{% if entry.CanDeleteJob %}
						<a href="#" class="delete_job_context_menu" PtpUploaderJobId='{{ entry.Id }}'><img src={{ url_for( "static", filename = "delete.png" ) }} title="Delete"></a>
					{% endif %}
				</td>
			</tr>
		{% else %}
			<tr>
				<td>No entries.</td>
			</tr>
		{% endfor %}
	</tbody>
</table>

<div class="pagination">
	{% if pagination.has_prev %}
		<a href="{{ url_for_other_page( pagination.page - 1 ) }}">&laquo; Prev</a>
	{% endif %}
	{%- for page in pagination.iter_pages() %}
		{% if page %}
			{% if page != pagination.page %}
				<a href="{{ url_for_other_page( page ) }}">{{ page }}</a>
			{% else %}
				<strong>{{ page }}</strong>
			{% endif %}
		{% else %}
			<span class="ellipsis">…</span>
		{% endif %}
	{%- endfor %}
	{% if pagination.has_next %}
		<a href="{{ url_for_other_page( pagination.page + 1 ) }}">Next &raquo;</a>
	{% endif %}
</div>

<script type=text/javascript src="{{ url_for( "static", filename = "script/jquery-1.7.1.min.js" ) }}"></script>
<link href="{{ url_for( "static", filename = "script/jquery.contextMenu/jquery.contextMenu.css" ) }}" rel="stylesheet" type="text/css" />
<script type=text/javascript src="{{ url_for( "static", filename = "script/jquery.contextMenu/jquery.contextMenu.js" ) }}"></script>
<script type=text/javascript src="{{ url_for( "static", filename = "script/jquery.contextMenu/jquery.ui.position.js" ) }}"></script>

<script type="text/javascript">
	var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

	function executeJobCommand(linkNode, jobId, jobCommand)
	{
		$.ajax(
		{
			type: "GET",
			url: $SCRIPT_ROOT + "/job/" + jobId + jobCommand,
			context: linkNode,
			success: function(msg)
			{
				$(this).text( msg );
				if ( msg == "OK" )
					$(this).fadeOut( "slow" );
			}
		} );
	}

	function executeDeleteJobCommand(linkNode, jobId, deleteMode)
	{
		$.ajax(
		{
			type: "GET",
			url: $SCRIPT_ROOT + "/job/" + jobId + '/delete/?mode=' + deleteMode,
			context: linkNode,
			success: function(msg)
			{
				if ( msg == "OK" )
					$( this ).parent().parent().fadeOut( "fast" );
				else
					$( this ).text( msg );
			}
		} );
	}

	$( function ()
	{
		$.contextMenu(
		{
			selector: '.delete_job_context_menu',
			trigger: 'left',
			callback: function( key, options )
			{
				var deleteLink = options.$trigger;
				var jobId = deleteLink.attr( 'PtpUploaderJobId' );
				if ( jobId.length > 0 )
				{
					executeDeleteJobCommand( deleteLink, jobId, key );
				}
			},
			items:
			{
				"DeleteJob": { name: "Delete job" },
				"DeleteJobAndSourceData": { name: "Delete job & source data" },
				"DeleteJobAndUploadData": { name: "Delete job & upload data" },
				"DeleteJobAndAllData": { name: "Delete job & all data" },
			}
		} );
	} );
</script>
{% endblock %}
