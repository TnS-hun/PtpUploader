{% extends "layout.html" %}

{% block head %}
{% endblock %}

{% block body %}

<form action="" enctype="multipart/form-data" method="post" id="upload_table">
	<table class="border" border="0" cellpadding="3" cellspacing="1">
		<tbody>
			<tr>
				<td class="label">Upload a torrent file</td>
				<td>
					<input type="file" id="upload_field" accept="application/x-bittorrent" title="You have to specify an IMDB or PTP link too."/>
					<input id="uploaded_torrentfilename" name="uploaded_torrentfilename" type="hidden">
				</td>
			</tr>

			<tr>
				<td class="label">Or specify a torrent page link</td>
				<td>
					<input id="torrent_site_link" name="torrent_site_link" size="60" type="text" title="Supported sites: CG, GFT, TL.">
				</td>
			</tr>

			<tr>
				<td class="label">Or select an existing file or folder</td>
			
				<td>
					<input id="existingfile" name="existingfile_input" size="60" title="This is not yet functional.">
					<input type="button" id="DirectorySelectorToggle" value="Browse" title="Directory selector.">
					<div id="directoryselector">
				</td>
			</tr>

			<tr>
				<td class="label">Release name</td>
				<td>
					<input id="release_name" name="release_name" size="60" type="text" title="The specified release name will be the name of the directory in the torrent uploaded to PTP. (Not supported yet on CG.)">
					<img src="{{ url_for( "static", filename = "throbber.gif" ) }}" style="display: none;" id="upload_throbber">
					<span id="uploaded_torrentcontentsizetext"></span>
					<input id="uploaded_torrentcontentsize" name="uploaded_torrentcontentsize" type="hidden">
				</td>
			</tr>
			
			{% include "job_common.html" %}

			<tr>
				<td colspan="2" style="text-align: center;">
					<br/>
					<br/>
					<input id="post" value="Upload torrent" type="submit">
					<br/>
					<br/>
					<br/>
				</td>
			</tr>
			
		</tbody>
	</table>
</form>

{% include "job_common_javascript.html" %}

<script src="{{ url_for( "static", filename = "script/jquery.html5_upload.js" ) }}"></script>
<script src="{{ url_for( "static", filename = "script/jqueryFileTree/jqueryFileTree.js" ) }}"></script>
<link href="{{ url_for( "static", filename = "script/jqueryFileTree/jqueryFileTree.css" ) }}" rel="stylesheet" type="text/css" />
<script src="{{ url_for( "static", filename = "script/jquery.blockUI.js" ) }}"></script>

<script>
	$(function ()
	{
		$( "#upload_field" ).html5_upload(
		{
			url: "{{ url_for( "ajaxUploadTorrentFile" ) }}",
			sendBoundary: true,
			fieldName: "file_input",
			stopOnFirstError: true,
			onStart: function(event, total)
			{
				$( "#upload_throbber" ).show();
				return true;
			},
			onFinishOne: function(event, response, name, number, total)
			{
				var jsonResponse = $.parseJSON( response );
				var jsonResult = jsonResponse[ "result" ];
				if ( jsonResult == "OK" )
				{
					$( "#uploaded_torrentfilename" ).val( jsonResponse[ "torrentFilename" ] );
					$( "#uploaded_torrentcontentsize" ).val( jsonResponse[ "torrentContentSize" ] );
					$( "#uploaded_torrentcontentsizetext" ).text( jsonResponse[ "torrentContentSizeText" ] );
					$( "#release_name" ).val( jsonResponse[ "releaseName" ] );
					$( "#upload_throbber" ).fadeOut( "slow" );
				}
				else
				{
					alert( "Error!" );
				}
			}
		});

		$( "#DirectorySelectorToggle" ).click( function()
		{
			$.blockUI(
			{
				message: $( "#directoryselector" ),
				fadeIn: 0,
				css:
				{
					width: $( "#directoryselector" ).width() + "px",
					left: ( $( window ).width() - $( "#directoryselector" ).width() ) / 2 + 'px',
					top: ( $( window ).height() - $( "#directoryselector" ).height() ) / 2 + 'px',
					textAlign: "left"
				}
			} );

			$( ".blockOverlay" ).click( function()
			{
				$( "#upload_throbber" ).show();

				var url = "{{ url_for( "ajaxGetInfoForFileUpload" ) }}";
				var path = $( "#existingfile" ).val();
				$.post( url, { "path": path  }, function(data)
				{
					if ( data.result == "OK" )
					{
						$( "#uploaded_torrentcontentsize" ).val( data.torrentContentSize );
						$( "#uploaded_torrentcontentsizetext" ).text( data.torrentContentSizeText );
						$( "#release_name" ).val( data.releaseName );
						$( "#imdb" ).val( data.imdbUrl );
						$( "#upload_throbber" ).fadeOut( "slow" );
					}
					else
					{
						alert( "Error!" );
					}
				} );

				$.unblockUI( { fadeOut: 0 } );
			} );
		} );

		$( "#directoryselector" ).fileTree(
		{
			root: "",
			script: "{{ url_for( "ajaxGetDirectoryList" ) }}",
			expandSpeed: -1,
			collapseSpeed: -1,
			multiFolder: true
		},
		function(file)
		{
			$( "#existingfile" ).val( file );
		} );
	});
</script>

{% endblock %}